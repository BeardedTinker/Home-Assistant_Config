#####
# New HA version noficitaion - WORK IN PROGRESS
# https://github.com/pinkywafer/Home-Assistant_Config/blob/master/packages/system/homeassistant_version.yaml
#####

id: c57b0367-ca6f-4e7b-8e18-307c4b44cf8b
alias: Home Assistant Update Notification
trigger:
  - platform: homeassistant
    event: start
  - platform: state
    entity_id: sensor.latest_version

condition:
  - condition: template
    value_template: >
      {{
      states("sensor.latest_version") != states("sensor.current_version")
      and states("sensor.latest_version") != "unknown"
      and states("sensor.latest_version") != states("input_text.version_latest_notified")
      }}

action:
# Set input text to latest HA value
- service: input_text.set_value
  data_template:
    entity_id: input_text.version_latest_notified
    value: '{{ states("sensor.latest_version") }}'

# Notify to my phone + Discord
- service: script.notify_engine
  data_template:
    who: 'discord'
    title: 'Update Home Assistant'
    value1: 'There is an update to Home Assistant Supervise'
    value2: '{{ states("sensor.current_version") }} -> {{ states("sensor.latest_version") }}'
    value3: 'Triggering Travis build...'
    tag_id: 'update_ha'
    sticky: 'true'
    group: ha_status
    color: '#ff8c00'
#    clickAction: /hassio/dashboard
    target_id: !secret discord_github_id

#- service: notify.mobile_app_eml_l29
#  data:
#    message: >
#      There is an update to Home Assistant Supervised
#        * {{ states("sensor.current_version") }} -> {{ states("sensor.latest_version") }}
#        Triggering Travis build...
#    title: Update Home Assistant
#    data:
#      sticky: 'true'
#      group: updates
#      tag: update_ha
#      color: '#ff8c00'
#      clickAction: /hassio/dashboard
#- service: notify.discord_bot
#  data_template:
#    target: !secret discord_github_id
#    message: >-
#      There is an update to Home Assistant Supervised
#        * {{ states("sensor.current_version") }} -> {{ states("sensor.latest_version") }}
#        Triggering Travis build...

- service: persistent_notification.create
  data_template:
    title: Update Home Assistant
    message: >
      There is an update to Home Assistant Supervised
        * {{ states("sensor.current_version") }} -> {{ states("sensor.latest_version") }}
        Triggering Travis build...
    notification_id: update_ha

# First we need to open issue 14 that tracks updates
- service: rest_command.new_version_github_issue
  data_template:
    status: "open"

# Then we post new status to issue 14
- service: rest_command.new_version_github_issue_comment
  data_template:
    message:  ' Upgrade Home Assistant from {{ states("sensor.current_version") }} to {{ states("sensor.latest_version") }} \n Release notes available via {{ state_attr("binary_sensor.updater","release_notes") }}. \n \n This comment was generated by Jarvis.","labels":["task: upgrade","task: maintenance"]} '
- service: rest_command.travis_build

# wait for travis build to start then update notification
- wait_template: "{{ is_state('sensor.beardedtinker_home_assistant_config_state', 'started') }}"

# Send notification that Travis started
- service: script.notify_engine
  data_template:
    who: 'discord'
    title: 'Update Home Assistant'
    value1: 'Travis Build has started'
    tag_id: 'update_ha'
    sticky: 'true'
    group: ha_status
    color: '#ff8c00'
#    clickAction: /hassio/dashboard
    target_id: !secret discord_github_id
    
#- service: notify.mobile_app_eml_l29
#  data:
#    message: >
#      There is an update to Home Assistant Supervised
#        * {{ states("sensor.current_version") }} -> {{ states("sensor.latest_version") }}
#        Travis Build has started
#    title: Update Home Assistant
#    data:
#      sticky: 'true'
#      tag: update_ha
#      color: '#ff8c00'
#      clickAction: /hassio/dashboard
#- service: notify.discord_bot
#  data_template:
#    target: !secret discord_github_id
#    message: "Travis Build has started"

- service: persistent_notification.create
  data_template:
    title: Update Home Assistant
    message: >
      There is an update to Home Assistant Supervised
        * {{ states("sensor.current_version") }} -> {{ states("sensor.latest_version") }}
        Travis Build has started
    notification_id: update_ha

# wait for build to complete and update notification with status
- wait_template: "{{ not is_state('sensor.beardedtinker_home_assistant_config_state', 'created') and not is_state('sensor.beardedtinker_home_assistant_config_state', 'started') }}"

- service: script.notify_engine
  data_template:
    who: 'discord'
    title: 'Update Home Assistant'
    value1: 'Travis Build has {{states("sensor.beardedtinker_home_assistant_config_state")}}'
    tag_id: 'update_ha'
    sticky: 'true'
    group: ha_status
    color: '#ff8c00'
#    clickAction: /hassio/dashboard
    target_id: !secret discord_github_id

#- service: notify.mobile_app_eml_l29
#  data:
#    message: >
#      There is an update to Home Assistant Supervised
#        * {{ states("sensor.current_version") }} -> {{ states("sensor.latest_version") }}
#        Travis Build has {{states('sensor.beardedtinker_home_assistant_config_state')}}
#    title: Update Home Assistant
#    data:
#      sticky: 'true'
#      tag: update_ha
#      color: '#ff8c00'
#      clickAction: /hassio/dashboard
#- service: notify.discord_bot
#  data_template:
#    target: !secret discord_github_id
#    message: "Travis Build has {{states('sensor.beardedtinker_home_assistant_config_state') }}"

- service: persistent_notification.create
  data_template:
    title: Update Home Assistant
    message: >
      There is an update to Home Assistant Supervised
        * {{ states("sensor.current_version") }} -> {{ states("sensor.latest_version") }}
        Travis Build has {{states('sensor.beardedtinker_home_assistant_config_state')}}
    notification_id: update_ha

# post issue comment on Travis status
- service: rest_command.new_version_github_issue_comment
  data_template:
    message: "Travis build has {{ states('sensor.beardedtinker_home_assistant_config_state') }}"